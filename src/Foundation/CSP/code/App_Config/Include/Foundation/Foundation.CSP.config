<?xml version="1.0" encoding="utf-8"?>
<!--
  Purpose: Configures Content Security Policy (CSP) header management through Sitecore CMS
  
  This configuration registers a pipeline processor that allows CSP headers to be managed
  through Sitecore items rather than web.config. When enabled, the processor will:
  - Read CSP settings from a Sitecore item
  - Build the CSP header dynamically
  - Inject it into HTTP responses
  - Fall back to web.config CSP header when disabled
-->
<configuration xmlns:patch="http://www.sitecore.net/xmlconfig/">
  <sitecore>
    <settings>
      <!-- 
        Path to the CSP settings item in Sitecore
        Default: /sitecore/content/RRA/Data/Settings/CSP
      -->
      <setting name="CSP.SettingsPath" value="/sitecore/content/RRA/Data/Settings/CSP" />
      
      <!-- 
        Database to use for retrieving CSP settings
        Use 'web' for published settings, 'master' for draft settings
        Default: master
      -->
      <setting name="CSP.Database" value="master" />
      
      <!-- 
        Skip CSP injection during content editing modes
        When true, CSP headers are not injected during:
        - Experience Editor
        - Preview mode
        - Debug mode
        - Any Sitecore backend operations
        Default: true (recommended for content authors)
      -->
      <setting name="CSP.SkipDuringEditing" value="true" />
    </settings>

    <pipelines>
      <httpRequestBegin>
        <!--
          CSP Header Processor
          
          Positioned after device resolution but before main processing.
          This ensures CSP headers are set early in the request lifecycle.
          
          When the Enabled checkbox in the CSP settings item is:
          - Checked: Uses CMS-managed CSP headers
          - Unchecked: Falls back to web.config CSP headers (if configured)
        -->
        <processor 
          type="Foundation.CSP.Pipelines.CspHeaderProcessor, Foundation.CSP"
          patch:after="processor[@type='Sitecore.Pipelines.HttpRequest.DeviceResolver, Sitecore.Kernel']" />
      </httpRequestBegin>
    </pipelines>

    <caches>
      <!--
        Cache for CSP settings to improve performance
        Size: 10MB (minimal memory footprint)
      -->
      <cache name="CSP.Settings" maxSize="10MB" />
    </caches>
  </sitecore>
</configuration>
